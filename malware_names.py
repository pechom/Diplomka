import json
import re
import collections
import glob

generic = {"win32", "variant", "spyware", "trojan", "worm", "virus", "heur", "trojandownloader", "generic",
           "malware", "ransom", "ransomware", "trojandropper", "autorun", "agent", "adware", "downloader", "infector",
           "backdoor", "hacktool", "bitcoinminer", "win64",
           "blocker", "proxy", "email", "injector", "inject", "softwarebundler", "virtool", "ddos", "exploit",
           "filecoder", "dropper", "sitehijack", "cryptolocker", "application", "deepscan", "keylogger", "obfuscated",
           "packed", "encrypted", "packer", "obfuscator", "encryptor", "malpack", "startpage", "servstart",
           "infostealer", "crypt", "rootkit", "passwordstealer", "optional", "genpack"}
more_generic = {"win32"}
wannacry = {"wannacry", "wannacrypt", "wanna", "wannacryptor"}
antivirus_names = ["kaspersky", "mcafee", "eset", "bitdefender"]

reports_path = 'C:/PycharmProjects/Diplomka/reports2/*'


def preprocess(path):
    files = sorted(glob.glob(path))
    names_kaspersky = names_mcafee = names_eset = names_bitdefender = ""
    longnames = []
    for name in files:
        with open(name) as f:
            data = json.load(f)
        kaspersky = data["scans"]["Kaspersky"]["result"]
        mcafee = data["scans"]["McAfee"]["result"]
        eset = data["scans"]["ESET-NOD32"]["result"]
        bitdefender = data["scans"]["BitDefender"]["result"]
        # names = names + microsoft + "," + kaspersky + mcafee + ","
        long_name = kaspersky+'#'+mcafee+'#'+eset+'#'+bitdefender
        longnames.append(long_name.lower())
        names_kaspersky = names_kaspersky + kaspersky + ","
        names_mcafee = names_mcafee + mcafee + ","
        names_eset = names_eset + eset + ","
        names_bitdefender = names_bitdefender + bitdefender + ","
    with open("subory/long_names.txt", "w") as file:
        for name in longnames:
            file.write(name+'\n')
    antiviruses = [names_kaspersky, names_mcafee, names_eset, names_bitdefender]
    return antiviruses


def classes(antiviruses):  # vrati mena tried ktore su v jednotlivych antivirusoch dost caste
    for i in range(len(antiviruses)):
        antivirus = antiviruses[i]
        antivirus = antivirus[:-1]
        antivirus = re.split('[_ :/.!,-]', antivirus)
        longNames = []
        out = open('subory/' + antivirus_names[i] + '.txt', 'w')
        for name in antivirus:
            if len(name) > 3:
                name = name.lower()
                if name not in generic:
                    if name in wannacry:
                        name = "wannacry"
                    longNames.append(name)
        c = collections.Counter(longNames)
        # pprint.pprint(c.most_common(len(longNames)))
        for name, count in c.items():
            if count > 49:
                out.write(name + '\n')
        out.close()


antiviruses = preprocess(reports_path)
# classes(antiviruses)
